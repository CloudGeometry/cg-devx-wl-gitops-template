variables:
  SOURCE_ENV:
    description: "Source environment"
    value: "dev"
    options:
      - "dev"
      - "sta"
      - "prod"
  TARGET_ENV:
    description: "Target environment"
    value: "dev"
    options:
      - "dev"
      - "sta"
      - "prod"
  PROMOTE_CONTAINER:
    description: "Promote container tag"
    value: "true"
    options:
      - "true"
      - "false"
  PROMOTE_CONFIGMAPS:
    description: "Also promote configmap settings"
    value: "true"
    options: 
      - "false"
      - "true"
  PROMOTE_SETTINGS:
    description: "Also promote workload settings"
    value: "false"
    options:
      - "true"
      - "false"
  COMMIT_MESSAGE: "workload promotion"

stages:
  - build
  - deploy

build-argo-cli:
  stage: build
  script: |
    # Download the binary
    curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.5.2/argo-linux-amd64.gz
    gunzip argo-linux-amd64.gz
    chmod +x argo-linux-amd64
    sudo mv ./argo-linux-amd64 /usr/local/bin/argo
    argo version

run-argo-cli:
  stage: deploy
  variables:
    REPO_NAME: $CI_PROJECT_NAME
    ARGO_NAMESPACE: wl-<WL_NAME>-build
    ARGO_INSTANCEID: cgdevx
  script: |
    pwd
    ls -lar
    argo submit .argo/promote-wf.yaml \
      -p repo=git@github.com:${REPO_NAME}.git \
      -p env-path="gitops/environments/envs" \
      -p source-env="${SOURCE_ENV}" \
      -p target-env="${TARGET_ENV}" \
      -p promote-container=${PROMOTE_CONTAINER} \
      -p promote-settings=${PROMOTE_SETTINGS} \
      -p promote-configmaps=${PROMOTE_CONFIGMAPS} \
      -p commit-message=\""${COMMIT_MESSAGE}"\" \
      --serviceaccount argo-workflow \
      --wait --log
